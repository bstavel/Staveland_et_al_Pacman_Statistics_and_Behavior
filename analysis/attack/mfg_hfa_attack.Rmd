---
title: "All ROI HFA Ghost Attack"
output: html_document
date: "2024-10-29"
---

```{r setup, include=FALSE}
## libraries ##
library(tidyverse)
library(ggplot2)
library(lmerTest)
library(doParallel)
library(parallel)
library(foreach)
library(here)
library(fs)
library(lmtest)
library(blme)
library(scales)
library(ggthemr)
library(RColorBrewer)
library(broom.mixed)
library(brms)

## hand written functions ##
source(path(here(), "R", 'mutate_cond.R'))
source(path(here(), "R", 'create_distance_df.R'))
source(path(here(), "R", 'clean_behavioral_data.R'))
source(path(here(), "R", 'compile_ieeg_csv_files.R'))
source(path(here(), "R", 'run_and_plot_lme_models.R'))
source(path(here(), "R", 'separate_mfg_sfg.R'))

## plotting helpers ##
ggthemr("light")
ghost_colors <- c("#E48DB7","#55BBC8", "#DE0D16")
getPalette = colorRampPalette(brewer.pal(17, "Set1"))

c25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)

```


## Testing for elevated HFA before and after attack in the MFG

This script has two main parts. First, it prepares and tests for differences in MFG HFA data before and after the onset of a Ghost Attack. It then calculate both the subject and electrode random effects and saves out the significant electrodes for further analysis.

Second, it looks at how the significant vs non-significant electrodes differ in terms of left/right hemisphere. After seeing that most significant electrodes were in the right hemisphere, we rerun the original model but with an interaction term for hemisphere.

It requires:
* `hfa_ieeg_dlpfc_all_subs_logged_iti_onset.csv` which is an output of `analyhsis/freq_power_analyses/compile_ieeg_files_iti_logged_trialonset.Rmd`
* `all_subs_complete_distance_df.csv` which is an output of `analysis/cleaning_ieeg_behavior/combine_ieeg_subs_behavior.Rmd`.
* `mni_coordinates_all_subs.csv` which is an output of `analysis/anatomical_plotting/create_mni_csv.Rmd`
* `SUBJECTID_attack_events.csv` files which are created by the individual subject cleaning scripts in `analysis/cleaning_ieeg_behavior/`

It produces:
* `attack_mfg_hfa_model_brms.RData` in the `results/attack` folder.
* `sig_electrodes_ci_mfg_attack_diff.csv` in the `munge/` folder.
* `attack_mfg_lr_hfa_model_brms.RData` in the `results/attack` folder.


```{r load-data}

## HFA ##
dlpfc_hfa_data <- read_csv( path(here(), "munge", "hfa_ieeg_dlpfc_all_subs_logged_iti_onset.csv"))

# separate dlpfc into sfg and mfg
dlpfc_hfa_data <- dlpfc_hfa_data %>%
  mutate(electrode = gsub("_.*", "", electrode))
dlpfc_hfa_data <- separate_mfg_sfg(dlpfc_hfa_data)
sfg_hfa_data <- dlpfc_hfa_data %>% filter(sfg == 1) %>% select(-sfg, -mfg)
mfg_hfa_data <- dlpfc_hfa_data %>% filter(mfg == 1) %>% select(-sfg, -mfg)


# behavioral data #
all_subs_g_dist <- read_csv(path(here(), "munge", "all_subs_complete_distance_df.csv"))
all_subs_ng_dist <- read_csv(path(here(), "munge", "all_subs_noghost_complete_distance_df.csv"))


# add ITI to behavioral df
behavior_iti_df <- all_subs_g_dist %>% 
  select(subject, trial_numeric, trial_time) %>%
  filter(trial_time < 1) %>%
  mutate(trial_time = round(trial_time - 1, 2))

all_subs_dist <- full_join(all_subs_g_dist, behavior_iti_df)


```

```{r merge-ieeg-hfa-data-behave-data}

ieeg_hfa_data <- mfg_hfa_data %>%
  mutate(freq = "hfa") %>%
  mutate(region = "MFG") %>%
  rename(power = theta) %>%
  mutate(electrode = gsub("_.*", "", electrode)) %>% 
  mutate(trial_time = trial_time - 3)  %>%
  filter(trial_time >= -1)


# bind with behavioral data #
ieeg_hfa_behave_df <- inner_join(all_subs_dist %>% select(-move_step) %>% mutate(trial_time = round(trial_time, 2)), 
                               ieeg_hfa_data %>% mutate(trial_time = round(trial_time, 2)))

```


```{r read-in-attack-tables}

## load and compile attack tables ##
for(sub in unique(all_subs_dist$subject)){
  
  tmp <- read_csv(path(here(), "data", "ieeg_behave", paste0(sub, "_attack_events.csv")))
  tmp <- tmp %>%
    mutate(subject = sub)
  
  if(exists("attack_events")){
    attack_events <- bind_rows(attack_events, tmp)
  } else {
    attack_events <- tmp
  }
  
}

## modify to get trials of interest ##
attack_events <- attack_events %>%
  mutate(trial_numeric = neural_trial_numeric + 1) %>%
  mutate(attacks_ids = paste0(subject, "_", trial_numeric))


```


```{r shift-to-attack}

# merge attack df
ieeg_attack_hfa_df <- left_join(ieeg_hfa_behave_df, attack_events %>% rename(attack_begin = event) %>% select(subject, trial_numeric, sample, attack_begin))
ieeg_attack_hfa_df <- ieeg_attack_hfa_df %>%
  mutate(attack_begin = if_else(is.na(attack_begin), 0, 1)) %>%
  group_by(subject, trial_numeric) %>%
  mutate(attacked = if_else(sum(attack_begin) != 0, 1, 0)) %>%
  ungroup()

# shift to center around turnaround  #
attack_hfa_centered_df <- ieeg_attack_hfa_df %>%
  filter(attacked == 1) %>%
  # round time so that we can loop over time later
  mutate(trial_time = round(trial_time, 2)) %>%
  # filiter out ITI
  filter(reward_groups != 99 & !is.na(electrode)) %>%
  # prep electrode variables
  mutate(elec_id = paste0(subject, "_", gsub("_.*", "", electrode))) %>%
  # shift the time so that time 0 is the start of movement onset
  group_by(elec_id, trial_numeric, subject, freq, region) %>%
  # filter time so that trials end when the person turnaround for the final time
  mutate(attack_time = if_else(attack_begin == 1, trial_time, 0)) %>%
  mutate(attack_time = max(attack_time)) %>%
  mutate(time = trial_time - attack_time) %>%
  ungroup() 

# create df for conflict, no conflict trials, based on what we did in the limbic theta power analyses
mfg_attack_plot_df <- attack_hfa_centered_df %>% 
    mutate(time = round(time, 2)) %>%
    filter(time <= 1 & time >= -1) %>%
    mutate(attack = if_else(time <=0, "Pre-Attack", "Post-Attack")) %>%
    group_by(elec_id, attack, trial_numeric) %>%
    mutate(trial_hfa = mean(power)) %>%
    select(trial_hfa, elec_id, trial_numeric, subject, attack) %>%
    distinct() 



```


```{r mfg-hfa-attack}

# Fit the model
mfg_model <- brm(
  formula = trial_hfa ~ attack + (1 + attack | subject/elec_id),
  data = mfg_attack_plot_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)




# save full model #
save(mfg_model, file = path(here(), "results", "attack", "attack_mfg_hfa_model_brms.RData"))

# load model
load(path(here(), "results", "attack", "attack_mfg_hfa_model_brms.RData"))
summary(mfg_model)

```

## Pull Random Effects to explore why we can see MFG changes, but not significant

```{r subject-random-effects}


# pull random efftcs
subject_random_effects <- ranef(mfg_model, groups = "subject")

# Extract posterior samples of random effects
posterior_ranef_subject <- as_draws_df(mfg_model) %>%
  select(starts_with("r_subject["))

posterior_ranef_electrode <- as_draws_df(mfg_model) %>%
  select(starts_with("r_subject:elec_id["))

# Extract posterior samples of the fixed effect
posterior_fixed <- as_draws_df(mfg_model, variable = "b_attackPreMAttack")

# Get the list of subjects
subjects <- unique(mfg_model$data$subject)

# Initialize a list to store subject-specific effect samples
subject_effects <- list()

# Loop over each subject
for (subject in subjects) {
  # Create the variable name for the random effect
  ranef_var <- paste0("r_subject[", subject, ",attackPreMAttack]")
  
  # Check if the variable exists in the posterior samples
  if (ranef_var %in% names(posterior_ranef_subject)) {
    ranef_samples <- posterior_ranef_subject[[ranef_var]]
  } else {
    stop(paste("Random effect variable", ranef_var, "not found in posterior samples."))
  }
  
  # Combine fixed and random effects
  subject_specific_samples <- posterior_fixed$b_attackPreMAttack + ranef_samples
  
  # Store the samples
  subject_effects[[as.character(subject)]] <- subject_specific_samples
}

```


```{r, subject-ci-on-res}

# Initialize a data frame to store the results
subject_ci <- data.frame(
  subject = character(),
  mean = numeric(),
  lower = numeric(),
  upper = numeric(),
  significant = logical(),
  stringsAsFactors = FALSE
)

for (subject in names(subject_effects)) {
  # Get the samples
  samples <- subject_effects[[subject]]
  
  # Calculate mean and credible intervals
  mean_effect <- mean(samples)
  ci_lower <- quantile(samples, probs = 0.025)
  ci_upper <- quantile(samples, probs = 0.975)
  
  # Determine if CI includes zero
  significant <- ci_lower > 0 | ci_upper < 0
  
  # Add to the data frame
  subject_ci <- rbind(subject_ci, data.frame(
    subject = subject,
    mean = mean_effect,
    lower = ci_lower,
    upper = ci_upper,
    significant = significant,
    stringsAsFactors = FALSE
  ))
}


```


```{r electrode-ranefs}

# Extract unique combinations of subject and elec_id from the model data
electrode_info <- unique(mfg_model$data[, c("subject", "elec_id")])

# Create a unique identifier for electrodes (subject_elec_id)
electrode_info$subject_elec_id <- paste0(electrode_info$subject, "_", electrode_info$elec_id)

# Initialize a list to store electrode-specific effect samples
electrode_effects <- list()

# Loop over each electrode
for (i in 1:nrow(electrode_info)) {
  subject <- electrode_info$subject[i]
  elec_id <- electrode_info$elec_id[i]
  subject_elec_id <- electrode_info$subject_elec_id[i]
  
  # Create variable names for random effects
  ranef_subject_var <- paste0("r_subject[", subject, ",attackPreMAttack]")
  ranef_electrode_var <- paste0("r_subject:elec_id[", subject_elec_id, ",attackPreMAttack]")
  
  # Check if variables exist in the posterior samples
  if (ranef_subject_var %in% names(posterior_ranef_subject)) {
    ranef_subject_samples <- posterior_ranef_subject[[ranef_subject_var]]
  } else {
    stop(paste("Random effect variable", ranef_subject_var, "not found in posterior samples."))
  }
  
  if (ranef_electrode_var %in% names(posterior_ranef_electrode)) {
    ranef_electrode_samples <- posterior_ranef_electrode[[ranef_electrode_var]]
  } else {
    stop(paste("Random effect variable", ranef_electrode_var, "not found in posterior samples."))
  }
  
  # Combine fixed effect, subject random effect, and electrode random effect
  electrode_specific_samples <- posterior_fixed$b_attackPreMAttack + ranef_subject_samples + ranef_electrode_samples
  
  # Store the samples
  electrode_effects[[subject_elec_id]] <- electrode_specific_samples
}


```

```{r elec-cis-on-res}

# Initialize a data frame to store the results
electrode_ci <-  data.frame(
  subject_elec_id = character(),
  subject = character(),
  elec_id = character(),
  mean = numeric(),
  lower = numeric(),
  upper = numeric(),
  significant = logical(),
  stringsAsFactors = FALSE
)

for (subject_elec_id in names(electrode_effects)) {
  # Get the samples
  samples <- electrode_effects[[subject_elec_id]]
  
  # Calculate mean and credible intervals
  mean_effect <- mean(samples)
  ci_lower <- quantile(samples, probs = 0.025)
  ci_upper <- quantile(samples, probs = 0.975)
  
  # Determine if CI includes zero
  significant <- ci_lower > 0 | ci_upper < 0
  
  # Extract subject and elec_id from subject_elec_id
  parts <- strsplit(subject_elec_id, "_")[[1]]
  subject <- parts[1]
  elec_id <- parts[2]
  
  # Add to data frame
  electrode_ci <- rbind(electrode_ci, data.frame(
    subject_elec_id = subject_elec_id,
    subject = subject,
    elec_id = elec_id,
    mean = mean_effect,
    lower = ci_lower,
    upper = ci_upper,
    significant = significant,
    stringsAsFactors = FALSE
  ))
}

electrode_ci <- electrode_ci %>%
  rowwise() %>%
  mutate(subject_names = paste0(subject, "_", subject, "_")) %>%
  mutate(electrode = gsub(subject_names, "", subject_elec_id)) %>%
  select(-subject_names, -elec_id) %>%
  mutate(first_elec = gsub("-.*", "", electrode)) %>%
  mutate(second_elec = gsub(".*-", "", electrode)) %>%
  mutate(big_attack_effect = if_else(significant, "yes", "no"))


# save significant electrode information
write_csv(electrode_ci, path(here(), "munge", "sig_electrodes_ci_mfg_attack_diff.csv"))


```


```{r localization-sig-elecs}

# load MNI data
mni_data <- read_csv(path(here(), "munge", "mni_coordinates_all_subs.csv"))

# merge with anatomy
leftright_data <- mni_data %>%
  mutate(left_right = if_else(X <= 0, "Left", "Right")) %>%
  select(subject, left_right, Electrode)

electrode_ci <- left_join(electrode_ci, leftright_data, by = c("subject" = "subject", "first_elec" = "Electrode"))

table(electrode_ci$left_right, electrode_ci$big_attack_effect)

```



### Left/Right Differences

Given that most of the significant electrodes are in the right hemisphere, lets rerun the model with an interaction for left/right side


```{r merge-lr-info}

# load MNI data
mni_data <- read_csv(path(here(), "munge", "mni_coordinates_all_subs.csv"))

# separate out the bipolar pairs
mfg_attack_plot_df <- mfg_attack_plot_df %>%
  mutate(electrode = gsub(paste0(subject, "_"), "", elec_id)) %>%
  mutate(first_elec = gsub("-.*", "", electrode)) %>%
  mutate(second_elec = gsub(".*-", "", electrode)) 

attack_hfa_centered_df <- attack_hfa_centered_df %>%
  mutate(first_elec = gsub("-.*", "", electrode)) %>%
  mutate(second_elec = gsub(".*-", "", electrode))   

# merge with anatomy
leftright_data <- mni_data %>%
  mutate(left_right = if_else(X <= 0, "Left", "Right")) %>%
  select(subject, left_right, Electrode)

mfg_attack_plot_df <- left_join(mfg_attack_plot_df, leftright_data, by = c("subject" = "subject", "first_elec" = "Electrode"))
attack_hfa_centered_df <- left_join(attack_hfa_centered_df, leftright_data, by = c("subject" = "subject", "first_elec" = "Electrode"))


```


```{r brms-lr-mfg}

# Set the number of cores for parallel processing
options(mc.cores = parallel::detectCores())

# set the priors #
priors <- c(
  prior(normal(0, 5), class = "Intercept"),            # Prior for the intercept
  prior(normal(0, 2), class = "b"),                    # Prior for fixed effects
  prior(exponential(1), class = "sd"),                 # Prior for random effects standard deviations
  prior(lkj(2), class = "cor")                         # Prior for random effects correlations
)


# Fit the model
mfg_lr_model <- brm(
  formula = trial_hfa ~ attack*left_right + (1 + attack | subject/elec_id),
  data = mfg_attack_plot_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)


# save full model #
save(mfg_lr_model, file = path(here(), "results", "attack", "attack_mfg_lr_hfa_model_brms.RData"))
load(path(here(), "results", "attack",  "attack_mfg_lr_hfa_model_brms.RData"))
summary(mfg_lr_model)

```
